version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:${QDRANT_IMAGE_TAG:-latest}
    ports:
      - ":6333"  # Expose the Qdrant API internally
      - ":6334"  # Expose the gRPC port internally
    expose:
      - 6333
      - 6334
      - 6335  # Expose the peer-to-peer port
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      # Security Configuration
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
      - QDRANT__SERVICE__READ_ONLY_API_KEY=${QDRANT_READ_ONLY_API_KEY}
      - QDRANT__SERVICE__ENABLE_TLS=${QDRANT_ENABLE_TLS:-false}
      - QDRANT__SERVICE__VERIFY_HTTPS_CLIENT_CERTIFICATE=${QDRANT_VERIFY_HTTPS_CLIENT:-false}
      - QDRANT__SERVICE__JWT_RBAC=${QDRANT_JWT_RBAC:-false}
      
      # Service Configuration
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__ENABLE_CORS=${QDRANT_ENABLE_CORS:-false}
      - QDRANT__SERVICE__CORS_ALLOW_ORIGINS=${QDRANT_CORS_ALLOW_ORIGINS}
      - QDRANT__SERVICE__MAX_REQUEST_SIZE_MB=${QDRANT_MAX_REQUEST_SIZE_MB:-32}
      
      # Logging
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
      
      # Storage Configuration
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=${QDRANT_ON_DISK_PAYLOAD:-true}
      
      # HNSW Index Configuration
      - QDRANT__STORAGE__HNSW_INDEX__M=${QDRANT_HNSW_M:-16}
      - QDRANT__STORAGE__HNSW_INDEX__EF_CONSTRUCT=${QDRANT_HNSW_EF_CONSTRUCT:-100}
      - QDRANT__STORAGE__HNSW_INDEX__ON_DISK=${QDRANT_HNSW_ON_DISK:-false}
      - QDRANT__STORAGE__HNSW_INDEX__FULL_SCAN_THRESHOLD_KB=${QDRANT_FULL_SCAN_THRESHOLD_KB:-10000}
      
      # Optimizer Configuration
      - QDRANT__STORAGE__OPTIMIZERS__DEFAULT_SEGMENT_NUMBER=${QDRANT_DEFAULT_SEGMENT_NUMBER:-0}
      - QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD_KB=${QDRANT_INDEXING_THRESHOLD_KB:-20000}
      
      # Performance Configuration
      - QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS=${QDRANT_MAX_SEARCH_THREADS:-0}
      - QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS=${QDRANT_MAX_OPTIMIZATION_THREADS:-0}
      
      # Cluster Configuration (disabled by default)
      - QDRANT__CLUSTER__ENABLED=${QDRANT_CLUSTER_ENABLED:-false}
      
      # Telemetry
      - QDRANT__TELEMETRY_DISABLED=${QDRANT_TELEMETRY_DISABLED:-true}

volumes:
  qdrant_data:
